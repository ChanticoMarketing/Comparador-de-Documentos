# Prompt para Completar la WebApp "OCR-Matcher AI"

**Rol Primario:** Eres un Agente de IA experto en desarrollo full-stack con React, TypeScript, Node.js, Express, Drizzle ORM y PostgreSQL. Tu tarea es completar las funcionalidades pendientes de la WebApp "OCR-Matcher AI" bas√°ndote en el c√≥digo existente y las especificaciones detalladas a continuaci√≥n.

**Objetivo Principal:** Finalizar la WebApp para que est√© 100% funcional, enfoc√°ndote en las √°reas no completadas, **SIN MODIFICAR NI AFECTAR NEGATIVAMENTE LA FUNCIONALIDAD CENTRAL EXISTENTE DE COMPARACI√ìN DE DOCUMENTOS** (subida de archivos, procesamiento OCR y comparaci√≥n con IA). Esta funcionalidad ya sirve y es cr√≠tica.

**Contexto General de la Aplicaci√≥n:**
La WebApp permite a los usuarios subir facturas y √≥rdenes de entrega para compararlas. Utiliza un servicio de OCR (API4AI) para extraer texto y un servicio de IA (OpenAI GPT-4o/GPT-4o-mini) para analizar y comparar los documentos, identificando coincidencias, advertencias y discrepancias. Los resultados se muestran en la interfaz y se pueden exportar a PDF/Excel. Las sesiones y resultados se almacenan en una base de datos PostgreSQL usando Drizzle ORM.

**Archivos Principales del Proyecto (revisar todos los archivos proporcionados para un entendimiento completo):**
* **Frontend (client/src/):** `App.tsx`, `pages/dashboard.tsx`, `pages/history.tsx`, `pages/settings.tsx`, `components/dashboard/*`, `components/layout/*`, `types/index.ts`, `lib/api.ts`, `lib/queryClient.ts`.
* **Backend (server/):** `index.ts`, `routes.ts`, `ocr.ts`, `matcher.ts`, `storage.ts`, `utils.ts`.
* **Compartido (shared/):** `schema.ts`.
* **Base de datos (db/):** `index.ts`, `seed.ts`.
* **Configuraci√≥n:** `package.json`, `vite.config.ts`, `drizzle.config.ts`, `tsconfig.json`.

---

## Tareas Detalladas por M√≥dulo/Funcionalidad:

### 1. Autenticaci√≥n y Gesti√≥n de Usuarios (Prioridad Alta)
    * **Descripci√≥n:** Actualmente existe una tabla `users` en `shared/schema.ts` pero no hay un sistema de autenticaci√≥n implementado. Es crucial asegurar la aplicaci√≥n.
    * **Tareas:**
        1.  **Backend:**
            * Implementar endpoints de API para registro (`/api/auth/register`), inicio de sesi√≥n (`/api/auth/login`), cierre de sesi√≥n (`/api/auth/logout`) y verificaci√≥n de sesi√≥n (`/api/auth/session`).
            * Utilizar `express-session` y `connect-pg-simple` (ya en `package.json`) para gestionar sesiones de usuario, almacen√°ndolas en la base de datos.
            * Utilizar `passport` y `passport-local` (ya en `package.json`) para la estrategia de autenticaci√≥n local.
            * Hashear contrase√±as antes de guardarlas en la base de datos (usar `bcrypt` o similar; a√±adir dependencia si es necesario).
            * Proteger todos los endpoints de API existentes (excepto los de autenticaci√≥n) para que solo usuarios autenticados puedan acceder.
            * Modificar `server/storage.ts` para que las funciones `createSession`, `getAllSessions`, `getSessionComparisons`, y `saveComparisonResult` se asocien y filtren por el `userId` del usuario autenticado. Esto implicar√° a√±adir un campo `userId` a las tablas `sessions` y, potencialmente, `comparisons` en `shared/schema.ts` y actualizar las relaciones y queries.
        2.  **Frontend:**
            * Crear p√°ginas/componentes para Login y Registro.
            * Modificar `App.tsx` para incluir rutas protegidas y p√∫blicas.
            * Implementar l√≥gica en `lib/api.ts` o un nuevo servicio de autenticaci√≥n para interactuar con los endpoints de auth.
            * Gestionar el estado de autenticaci√≥n del usuario globalmente (e.g., React Context o Zustand).
            * Mostrar condicionalmente opciones de Login/Logout en el layout.
            * La p√°gina de Configuraci√≥n (`pages/settings.tsx`) **DEBE** ser accesible solo por usuarios autenticados, ya que maneja API keys.
    * **Archivos Clave a Modificar (lista no exhaustiva):** `server/routes.ts`, `server/storage.ts`, `shared/schema.ts`, `client/src/App.tsx`, `client/src/lib/api.ts`, crear nuevas p√°ginas/componentes de autenticaci√≥n en `client/src/pages` o `client/src/components/auth`.
    * **Consideraci√≥n Importante:** La funcionalidad de comparaci√≥n de documentos (`/api/upload`, `processFiles` en `server/routes.ts`, `server/ocr.ts`, `server/matcher.ts`) debe permanecer intacta en su l√≥gica central, solo a√±adiendo la capa de autorizaci√≥n.

---

### 2. Visualizaci√≥n Detallada de Comparaciones (Rutas y Componentes)
    * **Descripci√≥n:** Actualmente, la vista de "Historial" (`pages/history.tsx`) enlaza a `/comparison/${session.id}`, pero esta ruta no est√° definida en `client/src/App.tsx` ni existe un componente dedicado para mostrar un resultado de comparaci√≥n espec√≠fico por su ID.
    * **Tareas:**
        1.  **Frontend:**
            * En `client/src/App.tsx`, a√±adir una nueva ruta parametrizada, por ejemplo: `<Route path="/comparison/:comparisonId" component={ComparisonDetailPage} />`.
            * Crear un nuevo componente/p√°gina `ComparisonDetailPage` (e.g., `client/src/pages/comparison-detail.tsx`).
            * Este nuevo componente deber√°:
                * Obtener el `comparisonId` del par√°metro de la ruta.
                * Utilizar `useQuery` (de `@tanstack/react-query`) y una funci√≥n de `lib/api.ts` para llamar al endpoint `/api/comparisons/:id` y obtener los datos de la comparaci√≥n espec√≠fica.
                * Reutilizar el componente `ResultsSection` pas√°ndole el `comparisonId` como prop para mostrar los resultados.
                * Envolver este contenido en `DashboardLayout` con un t√≠tulo adecuado (e.g., "Detalle de Comparaci√≥n #ID").
    * **Archivos Clave a Modificar:** `client/src/App.tsx`, `client/src/components/dashboard/results-section.tsx` (para asegurar que maneja bien el `comparisonId` prop), crear `client/src/pages/comparison-detail.tsx`.

---

### 3. Mejoras y Finalizaci√≥n del Servidor y L√≥gica de Negocio
    * **Descripci√≥n:** Varios puntos en el backend necesitan refinamiento para completar la funcionalidad y robustez.
    * **Tareas:**
        1.  **Configuraci√≥n Din√°mica del L√≠mite de Tama√±o de Archivo:**
            * En `server/routes.ts`, la configuraci√≥n de `multer` tiene un `fileSize` hardcodeado a 10MB.
            * Modificar esto para que, al inicializar `multer`, lea el valor `maxFileSize` desde la configuraci√≥n de la aplicaci√≥n almacenada en la base de datos (obtenida a trav√©s de `storage.getSettings()`). Si no hay settings, usar un default razonable (e.g., 10MB).
        2.  **Claridad en Nombres de Archivo para Comparaciones M√∫ltiples:**
            * En `server/routes.ts`, la funci√≥n `processFiles` actualmente toma `invoiceFiles[0].originalname` y `deliveryOrderFiles[0].originalname` para el `comparisonResult`, incluso si los textos de m√∫ltiples archivos son concatenados.
            * Modificar para que los nombres de archivo reflejen mejor el contenido procesado. Por ejemplo, si se concatenan m√∫ltiples archivos, el nombre podr√≠a ser "M√∫ltiples Facturas" o una lista concatenada de los primeros N nombres. Alternativamente, y preferiblemente si el tiempo lo permite, procesar cada par de factura/orden de entrega individualmente si se suben m√∫ltiples archivos, creando m√∫ltiples `ComparisonResult`. **Para esta fase, si la l√≥gica de comparaci√≥n individual es muy compleja, aseg√∫rate al menos que los nombres de archivo guardados sean representativos (e.g., "Facturas Consolidadas_timestamp" y "√ìrdenes Consolidadas_timestamp") y que la concatenaci√≥n de texto existente sea robusta.**
        3.  **Estado de API Din√°mico en Sidebar:**
            * El componente `client/src/components/layout/sidebar.tsx` muestra un estado de API hardcodeado como "verde".
            * Implementar endpoints `/api/status/api4ai` y `/api/status/openai` en `server/routes.ts` que hagan una prueba b√°sica (e.g., un request simple no costoso o verificar configuraci√≥n) a los respectivos servicios y devuelvan su estado (e.g., "ok", "error", "not_configured").
            * En el frontend, `Sidebar` deber√° hacer `useQuery` a estos endpoints y mostrar el estado din√°micamente.
        4.  **Funcionalidad "Guardar Resultados" (`POST /api/comparisons/save`):**
            * En `server/routes.ts`, este endpoint actualmente es un placeholder.
            * La configuraci√≥n `autoSaveResults` existe en `client/src/types/index.ts` y `shared/schema.ts`.
            * Si `autoSaveResults` est√° desactivado en la configuraci√≥n, el bot√≥n "Guardar resultados" en `ResultsSection` debe activarse.
            * El endpoint `/api/comparisons/save` debe, si es necesario, realizar una acci√≥n espec√≠fica (e.g., marcar un resultado como "guardado permanentemente" o simplemente confirmar que ya est√° guardado si `autoSaveResults` estaba activo). Actualmente, `storage.saveComparisonResult` ya guarda los resultados detallados. Si `autoSaveResults` es `false`, la l√≥gica en `processFiles` no deber√≠a llamar a `storage.saveComparisonResult` autom√°ticamente. En su lugar, `processFiles` podr√≠a guardar el resultado en un estado temporal (quiz√°s en `processingState` o una cach√© temporal) y el endpoint `/api/comparisons/save` transferir√≠a esto a la base de datos persistente. **Por simplicidad para esta fase, si `autoSaveResults` es `false`, el resultado NO se guarda autom√°ticamente. El endpoint `/api/comparisons/save` (accionado por el bot√≥n) entonces llamar√° a `storage.saveComparisonResult` con los datos del √∫ltimo resultado procesado (que necesitar√°s almacenar temporalmente si no se guard√≥).**
        5.  **Robustez del Servicio OCR (`server/ocr.ts`):**
            * La funci√≥n `splitPdf` es un mock. Si la API de API4AI no maneja bien PDFs de m√∫ltiples p√°ginas o si se requiere un an√°lisis p√°gina por p√°gina antes de la extracci√≥n de texto, esta funci√≥n necesitar√≠a ser implementada usando una librer√≠a como `pdf-lib`. **Considerar esto de baja prioridad si API4AI maneja PDFs de m√∫ltiples p√°ginas adecuadamente, para no arriesgar la funcionalidad OCR existente.**
            * Las funciones `extractTables` y `extractMetadata` son heur√≠sticas. Evaluar si la calidad actual es suficiente o si el `MatcherService` compensa sus limitaciones. **No modificar a menos que sea estrictamente necesario para la funcionalidad b√°sica de comparaci√≥n.**
    * **Archivos Clave a Modificar:** `server/routes.ts`, `server/storage.ts`, `server/ocr.ts` (potencialmente), `client/src/components/layout/sidebar.tsx`, `client/src/components/dashboard/results-section.tsx`.

---

### 4. Mejoras Generales y UI/UX
    * **Descripci√≥n:** Peque√±os ajustes para mejorar la experiencia del usuario y la completitud.
    * **Tareas:**
        1.  **Not Found Page (`client/src/pages/not-found.tsx`):**
            * Actualmente dice "Did you forget to add the page to the router?". Cambiar el mensaje a algo m√°s amigable para el usuario final, como "¬°Ups! P√°gina no encontrada. Parece que te perdiste." y ofrecer un bot√≥n para "Volver al Dashboard".
        2.  **Consistencia en Mensajes de Error y √âxito (Toasts):**
            * Revisar el uso de `useToast` en todos los componentes y asegurar que los mensajes sean claros, consistentes y est√©n traducidos al espa√±ol donde aplique.
        3.  **Manejo de Cancelaci√≥n de Procesamiento:**
            * En `server/routes.ts`, dentro de `processFiles`, verificar peri√≥dicamente si `processingState.isProcessing` sigue siendo `true`. Si cambia a `false` (indicando una cancelaci√≥n), detener el procesamiento de manera elegante (ej. dejar de iterar sobre archivos, no hacer m√°s llamadas a APIs externas) y limpiar los archivos temporales.
    * **Archivos Clave a Modificar:** `client/src/pages/not-found.tsx`, varios componentes de frontend que usan `toast`, `server/routes.ts`.

---

**Restricciones Cr√≠ticas (¬°No olvidar! üíÄ):**
1.  **NO ROMPER LA COMPARACI√ìN DE DOCUMENTOS:** La l√≥gica central de `server/ocr.ts` (extracci√≥n de texto con API4AI), `server/matcher.ts` (comparaci√≥n con OpenAI y formateo del resultado JSON), y el flujo de procesamiento iniciado por `/api/upload` deben permanecer funcionales como est√°n en su n√∫cleo. Las modificaciones deben ser aditivas o para correcci√≥n de errores obvios, sin alterar la estructura del resultado de comparaci√≥n (`ComparisonResult`) que ya se espera.
2.  **MANTENER ESTILO DE C√ìDIGO Y TECNOLOG√çAS:** Usar TypeScript, React con Hooks, TailwindCSS, shadcn/ui componentes, Express, Drizzle ORM, y las librer√≠as ya presentes en `package.json`.
3.  **ENTORNO DE DESARROLLO:** El proyecto se desarrolla en Replit. Asegurar que las soluciones sean compatibles con este entorno.

**Formato de Salida Esperado:**
El c√≥digo modificado y los nuevos archivos necesarios para implementar todas las tareas descritas. Comenta brevemente en el c√≥digo las secciones a√±adidas o modificadas significativamente.

**Consideraci√≥n Final:** Si alguna tarea entra en conflicto directo con la restricci√≥n de no afectar la funcionalidad de comparaci√≥n, prioriza la estabilidad de la comparaci√≥n y anota la tarea como "pendiente de clarificaci√≥n" o prop√≥n una alternativa segura.

---
Aseg√∫rate de que la IA entienda bien la prioridad de la autenticaci√≥n y la nueva ruta para ver comparaciones espec√≠ficas, ya que son las piezas m√°s grandes que faltan para una aplicaci√≥n "completa" m√°s all√° del n√∫cleo de comparaci√≥n. ¬°Mucha suerte, y que la fuerza (y el caf√© ‚òï) te acompa√±en! Si esto sale bien, ¬°hasta te invito unas chelas virtuales! üçª De lo contrario... bueno, ya sabes. üòâ